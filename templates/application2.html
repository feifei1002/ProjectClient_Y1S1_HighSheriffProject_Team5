{% include 'boostrap.html'%}
{% include 'nav.html'%}
<main>
    <section class="container-fluid justify-contents-center text-center">
        <h2>Video Interview</h2>
        <video id="webcam" autoplay muted></video>
        <video id="playback" controls></video>
        <button id='record' onclick="record()">Start Recording</button>
        <button id='stopRecord' onclick="stop()">Stop Recording</button>
        <button id='playback' onclick="play()">Playback recording</button>
        <p id='checkComp' style="display: none;">It seems your browser does not support getUserMedia. You will need to apply with the old-style form or use a different browser.</p>
        <form method="post" enctype="multipart/form-data" action="/Application/interactiveForm">
            <input type="file" name="file">
            <input type="submit" value="Upload" accept="video/*" capture> <!-- Capture attribute only works for mobile phones-->
        </form>
    </section>
    <script>
        var videoChunks = []; // Apparently the video is stored in blobs on chunks and we need to save them here
        var options = {mimeType: 'video/webm'};

        function checkUserIsCompatible(){ // Checks if the user's browser supports user media
            var check = !!(navigator.mediaDevices.getUserMedia);
            if(check){
                const constraints = {video: { width: 1024, height: 576}, audio: true};
                const video = document.getElementById("webcam");
                navigator.mediaDevices.getUserMedia(constraints).then((stream) => {video.srcObject = stream;}); // Aks the user for permission then plays their own webcame to them
                prepMediaRecorder(constraints);
            } else {
                document.getElementById("checkComp").style = "display: block;";
            }
        }

        async function prepMediaRecorder(constraints){
            let stream = null;

            try{
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.ondataavailable = handleDataAvailable;
            } catch(error){
                alert("Error");
            }
        }

        function record(){
            mediaRecorder.start();
        }

        function stop(){
            mediaRecorder.stop();
        }

        function play(){
            var videoPlayback = document.getElementById("playback");
            var superBuffer = new Blob(videoChunks);
            videoPlayback.src = window.URL.createObjectURL(superBuffer);
        }

        function handleDataAvailable(event){ // Stores video into the video chunks array
            if(event.data.size > 0){
                videoChunks.push(event.data);
            }
        }
        checkUserIsCompatible()
    </script>
</main>